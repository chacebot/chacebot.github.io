---
layout: post
topic: Programming
title: Code Walkthrough, FreeRTOS and libopencm3 on the Chacebot Microcontroller
---

Chacebot uses an STM32F103C8T6 microcontroller to intrepret PWM signals from a three channel RC reciever and streams the values over the serial port to control the drivetrain of the robot. This post contains an overview of the hardware setup and explains the firmware I implemented to make this embedded system work efficently. The code I developed in this project is an extension from a chapter in Warren Gay's book : [Beginning STM32: Developing with FreeRTOS, libopencm3 and GCC](https://www.amazon.com/Beginning-STM32-Developing-FreeRTOS-libopencm3/dp/1484236238), specifically Chapter 17 titled "PWM Input with Timer 4".

The reason why I purchased Warren's book was so that I can learn more about embedded systems and implement this RC reciever interpreting functionality in a more elegant way than the lower hanging fruit alternative which was to use an Arduino. Using the arduino for this would have been very easy because the arduino platform has built in functions that allow you pick an analog input pin and will set up the relevant timers and scale the length of the pulse under the hood without having to write all of the code to do so. However this is not how this system would be deployed in industry because the Arduino platform is not scalable and it does not allow for multitasking. Everything in Arduino is synchronous meaning it only does one task at a time, therefore there is the possibility of missing input signals since it cannot monitor all RC input pins at the same time. This is where FreeRTOS comes in. Through Warren's book I was able to learn how to implement premptive multitasking which I will just refer too as a "task". This allows for me to set up modular routines or "jobs" that can be initatied and run at the discression of the microprocessor scheduler which is very efficient. Running multiple jobs this way does not always mean that they are done in parrallel, however it does enable asynchronous behavior. 

![Chacebot RC Control Setup](/assets/images/blog/june2020/chacebot-stm32.jpg)

Above, the chacebot STM32 setup is shown. This includes the off the shelf RC transmitter and reciever combo ($30 from amazon) which is used for any typlical RC hobby application. The RC Reciever (little black box with an antenna) is mounted via VHB foam tape to a breadboard containing the STM32F103 microcontroller. The STM32 is wired to the RC reviever using jumper wires running Vcc (+5v), GND, and connections between channel 1, 2, 3 of the RC reviever to pins PB6, PA6, and PA0 respectivly. The pinout diagram for the STM32 board below indicates the physical location of these pins:

![STM32 Pinout](/assets/images/blog/june2020/STM32-Pinout.png)

